#Profile Label : RHEL 7 Graphical server without running the scap remediation plugin
#Date Created : 2017-04-27
#Last Modifed : 2023-11-01
#Author : Trae Elmore
#assumption : you are using the standard rhel server dvd iso for RHEL 7.9
#assumption : the vm has at least a 40GBdisk drive, grow logical volumes as desired post install
#passwords : for this file the root, grub2, and ladmin user passwords are Pa33w0rd. Please change to suitable production values prior to deployment outside of your lab.
#example with kvm on linux : sudo virt-install --connect=qemu:///system --network bridge:virbr1 --ram 1024 --vcpus=1 --initrd-inject=/var/lib/libvirt/images/isos/workstation.cfg --extra-args="ks=file:/workstation.cfg console=tty0 console=ttyS0,115200" --name=workstation1 --disk pool=default,size=40 --location /var/lib/libvirt/images/isos/rhel7-workstation.iso

install
text
network --bootproto dhcp --onboot yes --noipv6
cdrom
lang en_US
keyboard us
zerombr
clearpart --all
bootloader --location mbr --iscrypted --password=grub.pbkdf2.sha512.10000.C0379B40AD5EEBAB7DCBAB625C9AC4253BB61D9AF8BD62E017F1A14F011A70A703F42DF2BB0A11A194337C52EEC45ABB6AD49B8D6AEC4B8647AADE9DBCC564B4.6227EFA27018BEC574CF32C47A7BB139095A2B4A68B002E9553C9500AAEDE38A9C56D7C2D0333B7F396D6EEEA41270EAA86ED92865C93A706D03179CA7713B3B
timezone America/Chicago
eula --agreed
auth --enableshadow --passalgo=sha512
rootpw --iscrypted $6$75v.Iu/m$xcw0IusqJiXa0iNzZi9zHw.WUqYJA8FDLwdXzsHolEQE76kNJyWyY268ajVsAimdnMTIbBp/7X6JzuPpGN1PD0
user --name=ladmin --groups=wheel --gecos="local admin user" --iscrypted --password=$6$75v.Iu/m$xcw0IusqJiXa0iNzZi9zHw.WUqYJA8FDLwdXzsHolEQE76kNJyWyY268ajVsAimdnMTIbBp/7X6JzuPpGN1PD0
selinux --enforcing
reboot
firewall --enabled --ssh
firstboot --disabled
clearpart --all
part /boot --fstype xfs --size=1000 --label=BOOTFS
part /boot/efi --fstype vfat --size=1000 --label=EFIFS
part pv.3 --size=100 --grow
volgroup sysvg --pesize=4096 pv.3
logvol / --fstype xfs --name=lv_root --vgname=sysvg --size=16000 --label=ROOTFS
logvol /var --fstype xfs --name=lv_var --vgname=sysvg --size=4000 --label=VARFS --fsoptions="nodev"
logvol /var/log --fstype xfs --name=lv_log --vgname=sysvg --size=2000 --label=LOGFS --fsoptions="nodev"
logvol /var/log/audit --fstype xfs --name=lv_audit --vgname=sysvg --size=2000 --label=AUDITFS --fsoptions="nodev"
logvol /home --fstype xfs --name=lv_home --vgname=sysvg --size=2000 --label=HOMEFS --fsoptions="nodev"
logvol /tmp --fstype xfs --name=lv_tmp --vgname=sysvg --size=4000 --label=TMPFS --fsoptions="nodev,noexec,nosuid"
logvol /var/tmp --fstype xfs --name=lv_var_tmp --vgname=sysvg --size=4000 --label=VAR_TMPFS --fsoptions="nodev,noexec,nosuid"
logvol swap --fstype swap --name=lv_swap --vgname=sysvg --size=1000 --label=SWAPFS

%addon com_redhat_kdump --disable
%end

#%addon org_fedora_oscap
#      content-type = scap-security-guide
#      profile = xccdf_org.ssgproject.content_profile_ncp
#%end

%packages
@^graphical-server-environment
@base
@core
@desktop-debugging
@dial-up
@fonts
@input-methods
@gnome-desktop
@guest-desktop-agents
@hardware-monitoring
@internet-browser
@development
@multimedia
@print-client
@x11
@directory-client
@network-file-system-client
@networkmanager-submodules
vim
#stig required packages
aide
dracut-fips
dracut-fips-aesni
gnupg2
yum-utils
tpm-tools
which
unzip
bzip2
zip
xorg-x11-xauth
screen
vlock
esc
pam_pkcs11
pcsc-lite
ccid
opensc
# SCAP Content
openscap
openscap-scanner
xml-common
scap-security-guide
# stig exclude packages
-abrt*
-avahi*
-iwl*
-ivtv-firmware
-rsh
-rsh-server
-talk
-talk-server
-telnet
-telnet-server
-xinetd
-ypbind
-ypserver
%end

###############################################################################
# Post-Installation Scripts
###############################################################################
%post
####
# import the distribution gpg key for package checking
####
rpm --import /etc/pki/rpm-gpg/*

####
#remove unneeded users and idle users
####
userdel uucp
userdel sync
userdel news
userdel games
userdel gopher
userdel shutdown

####
#disable uncommon and blacklisted protocols
####
echo -e "install appletalk /bin/true\ninstall bluetooth /bin/true\ninstall dccp /bin/true\ninstall sctp /bin/true\ninstall rds /bin/true\ninstall tipc /bin/true\ninstall bluetooth /bin/true" |sudo tee -a /etc/modprobe.d/stig.conf
###
#disable uncommon filesystems
###
echo -e "install cramfs /bin/true\ninstall freevxfs /bin/true\ninstall jffs2 /bin/true\ninstall hfs /bin/true\ninstall hfsplus /bin/true\ninstall squashfs /bin/true\ninstall udf /bin/true" |sudo tee -a /etc/modprobe.d/stig.conf
###
#disable users attaching usb storage per DISA and NSA
###
echo "install usb-storage /bin/true" >> /etc/modprobe.d/stig.conf

###
# disable bluetooth service
###
systemctl mask bluetooth.service

#### 
##limit root to console
####
echo -e "tty1\ntty2" > /etc/securetty
chmod 700 /root

###
#disable CTRL-ALT-DEL
###
echo "CtrlAltDelBurstAction=none" >>/etc/systemd/system.conf

####
# Set account expiration following inactivity
####
sed -i 's/INACTIVE=1/INACTIVE=0/' /etc/default/useradd

########
#log rotation
########
sed -i 's/rotate 4/rotate 52/' /etc/logrotate.conf
sed -i 's/#compress/compress/' /etc/logrotate.conf

######
#Setup LIBWRAP
######
cat <<EOF >> /etc/hosts.allow
###
# LOCALHOST (ALL TRAFFIC ALLOWED) DO NOT REMOVE FOLLOWING LINE
ALL: 127.0.0.1
# Allow SSH 
sshd: ALL
EOF
cat <<EOF >> /etc/hosts.deny
###
# Deny All by Default
ALL: ALL
EOF

###
#All files and directories must have a valid owner.
###
sudo find / -fstype xfs -nouser -print -exec  chown nobody {} \;
sudo find / -fstype xfs -nogroup -print -exec chown :nobody {} \;
cat << EOF |sudo tee -a /etc/cron.daily/file-owner-check.sh
#!/bin/bash
find / -fstype xfs -nouser -print -exec  chown nobody {} \;
find / -fstype xfs -nogroup -print -exec chown :nobody {} \;
EOF
chmod 700 /etc/cron.daily/file-owner-check.sh

####
#console screen lock
####
cat <<EOF > /etc/profile.d/vlock-alias.sh
#!/bin/sh
alias vlock='clear;vlock -a'
EOF
cat <<EOF > /etc/profile.d/vlock-alias.csh
#!/bin/csh
alias vlock 'clear;vlock -a'
EOF
chown root:root /etc/profile.d/vlock-alias.{sh,csh}
chmod 755 /etc/profile.d/vlock-alias.{sh,csh}

###
#disable idle sessions
###
cat <<EOF > /etc/profile.d/stig-timeout.sh
#!/bin/sh
TMOUT=600
export TMOUT
readonly TMOUT
EOF
cat <<EOF > /etc/profile.d/stig-timeout.csh
#!/bin/csh
set autologout=10
set -r autologout
EOF
chown root:root /etc/profile.d/stig-timeout.{sh,csh}
chmod 755 /etc/profile.d/stig-timeout.{sh,csh}

#####
# Wheel Group Require (sudo)
#####
sed -i -re '/pam_wheel.so use_uid/s/^#//' /etc/pam.d/su
sed -i 's/^#\s*\(%wheel\s*ALL=(ALL)\s*ALL\)/\1/' /etc/sudoers
echo -e "\n## Set timeout for authentiation (5 Minutes)\nDefaults:ALL timestamp_timeout=5\n" >> /etc/sudoers

####
#Password aging
####
cat /etc/login.defs | sed -e 's/^PASS_MAX_DAYS.*[0-9]/PASS_MAX_DAYS 60/g' -e 's/^PASS_MIN_DAYS.*[0-9]/PASS_MIN_DAYS 1/g' -e 's/^PASS_MIN_LEN.*[0-9]/PASS_MIN_LEN 5/g' -e's/^PASS_WARN_AGE.*[0-9]/PASS_WARN_AGE 7/g' >/etc/login.defs.new
echo "FAIL_DELAY 4" >>/etc/login.defs.new
mv /etc/login.defs /etc/login.defs.bak
mv /etc/login.defs.new /etc/login.defs
chmod 644 /etc/login.defs

cat <<EOF > /etc/security/pwquality.conf
# Configuration for systemwide password quality limits
# Defaults:
#
# Number of characters in the new password that must not be present in the
# old password.
# difok = 5
difok = 8
#
# Minimum acceptable size for the new password (plus one if
# credits are not disabled which is the default). (See pam_cracklib manual.)
# Cannot be set to lower value than 6.
# minlen = 9
minlen = 15
#
# The maximum credit for having digits in the new password. If less than 0
# it is the minimum number of digits in the new password.
# dcredit = 1
dcredit = -1
#
# The maximum credit for having uppercase characters in the new password.
# If less than 0 it is the minimum number of uppercase characters in the new
# password.
# ucredit = 1
ucredit = -1
#
# The maximum credit for having lowercase characters in the new password.
# If less than 0 it is the minimum number of lowercase characters in the new
# password.
# lcredit = 1
lcredit = -1
#
# The maximum credit for having other characters in the new password.
# If less than 0 it is the minimum number of other characters in the new
# password.
# ocredit = 1
ocredit = -1
#
# The minimum number of required classes of characters for the new
# password (digits, uppercase, lowercase, others).
minclass = 4
#
# The maximum number of allowed consecutive same characters in the new password.
# The check is disabled if the value is 0.
maxrepeat = 2
#
# The maximum number of allowed consecutive characters of the same class in the
# new password.
# The check is disabled if the value is 0.
maxclassrepeat = 4
#
# Whether to check for the words from the passwd entry GECOS string of the user.
# The check is enabled if the value is not 0.
# gecoscheck = 0
#
# Path to the cracklib dictionaries. Default is to use the cracklib default.
# dictpath =
EOF

cat <<EOF > /etc/pam.d/system-auth-local
#%PAM-1.0
auth required pam_env.so
auth required pam_lastlog.so inactive=35
auth required pam_faillock.so preauth silent audit deny=3 even_deny_root root_unlock_time=900 unlock_time=604800 fail_interval=900
auth sufficient pam_unix.so try_first_pass
auth [default=die] pam_faillock.so authfail audit deny=3 even_deny_root root_unlock_time=900 unlock_time=604800 fail_interval=900
auth sufficient pam_faillock.so authsucc audit deny=3 even_deny_root root_unlock_time=900 unlock_time=604800 fail_interval=900
auth requisite pam_succeed_if.so uid >= 1000 quiet
auth required pam_deny.so
account required pam_faillock.so
account required pam_unix.so
account required pam_lastlog.so inactive=35
account sufficient pam_localuser.so
account sufficient pam_succeed_if.so uid < 1000 quiet
account required pam_permit.so
# Password Quality now set in /etc/security/pwquality.conf
password required pam_pwquality.so retry=3
password sufficient pam_unix.so sha512 shadow try_first_pass use_authtok remember=5
password required pam_deny.so
session required pam_lastlog.so showfailed
session optional pam_keyinit.so revoke
session required pam_limits.so
-session optional pam_systemd.so
session [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
session required pam_unix.so
EOF
ln -sf /etc/pam.d/system-auth-local /etc/pam.d/system-auth
cp -f /etc/pam.d/system-auth-local /etc/pam.d/system-auth-ac

cat <<EOF > /etc/pam.d/password-auth-local
#%PAM-1.0
auth required pam_env.so
auth required pam_lastlog.so inactive=35
auth required pam_faillock.so preauth silent audit deny=3 even_deny_root root_unlock_time=900 unlock_time=604800 fail_interval=900
auth sufficient pam_unix.so try_first_pass
auth [default=die] pam_faillock.so authfail audit deny=3 even_deny_root root_unlock_time=900 unlock_time=604800 fail_interval=900
auth sufficient pam_faillock.so authsucc audit deny=3 even_deny_root root_unlock_time=900 unlock_time=604800 fail_interval=900
auth requisite pam_succeed_if.so uid >= 1000 quiet
auth required pam_deny.so
account required pam_faillock.so
account required pam_unix.so
account required pam_lastlog.so inactive=35
account sufficient pam_localuser.so
account sufficient pam_succeed_if.so uid < 1000 quiet
account required pam_permit.so
# Password Quality now set in /etc/security/pwquality.conf
password required pam_pwquality.so retry=3
password sufficient pam_unix.so sha512 shadow try_first_pass use_authtok remember=5
password required pam_deny.so
session required pam_lastlog.so showfailed
session optional pam_keyinit.so revoke
session required pam_limits.so
-session optional pam_systemd.so
session [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
session required pam_unix.so
EOF
ln -sf /etc/pam.d/password-auth-local /etc/pam.d/password-auth
cp -f /etc/pam.d/password-auth-local /etc/pam.d/password-auth-ac
echo "password required pam_pwquality.so retry=3" >>/etc/pam.d/passwd

cat <<EOF > /etc/pam.d/postlogin-local
#%PAM-1.0
session     [success=1 default=ignore] pam_succeed_if.so service !~ gdm* service !~ su* quiet
session     [default=1]   pam_lastlog.so nowtmp showfailed
session     optional      pam_lastlog.so silent noupdate showfailed
EOF
ln -sf /etc/pam.d/postlogin-local /etc/pam.d/postlogin
cp -f /etc/pam.d/postlogin-local /etc/pam.d/postlogin-ac


#######
#preserve systemd journal
#######
mkdir /var/log/journal
chown root:systemd-journal /var/log/journal
chmod 2775 /var/log/journal

###
#add audit rule tweaks and increase audit buffer
###
sed -i '/max_log_file/s/8/90/' /etc/audit/auditd.conf
sed -i '/num_logs/s/5/90/' /etc/audit/auditd.conf
sed -i '/space_left_action/s/SYSLOG/EMAIL/' /etc/audit/auditd.conf
sed -i '/admin_space_left_action/s/SUSPEND/SINGLE/' /etc/audit/auditd.conf
sed -i '/admin_space_left/s/75/500/' /etc/audit/auditd.conf
sed -i '/^space_left/s/75/1200/' /etc/audit/auditd.conf
sed -i '/disk_full_action/s/SUSPEND/SINGLE/' /etc/audit/auditd.conf
#sed -i '/flush/s/INCREMENTAL_ASYNC/DATA/' /etc/audit/auditd.conf
echo "action_mail_acct = root" >>/etc/audit/auditd.conf
sed -i '/active/s/yes/no/' /etc/audisp/plugins.d/syslog.conf
rm -rf /etc/audit/rules.d/*
cat <<EOF > /etc/audit/rules.d/audit.rules
# DISA STIG Audit Rules
## Add keys to the audit rules below using the -k option to allow for more 
## organized and quicker searches with the ausearch tool.  See auditctl(8) 
## and ausearch(8) for more information.
# Remove any existing rules
-D
# Buffer Size
## Feel free to increase this if the machine panic's
-b 32768
# Failure Mode
## Possible values: 0 (silent), 1 (printk, print a failure message), 2 (panic, halt the system)
-f 2
# Ignore errors
## e.g. caused by users or files not found in the local environment  
-i 

## Auditd configuration
### Modifications to audit configuration that occur while the audit collection functions are operating
-w /etc/audit/ -p wa -k auditconfig
-w /etc/libaudit.conf -p wa -k auditconfig
-w /etc/audisp/ -p wa -k audispconfig

## Monitor for use of audit management tools
-w /sbin/auditctl -p x -k audittools
-w /sbin/auditd -p x -k audittools

# Filters ---------------------------------------------------------------------
### We put these early because audit is a first match wins system.

####
#filtering out policy kit noise
####
-a never,exit -F arch=b64 -F exe="/usr/bin/pkla-check-authorization" -F subj=system_u:system_r:policykit_auth_t:s0 -F key=(null)

####
#improve patching performance and development activity in home
####
-a exit,never -F dir=/home -k exclude
-a exit,never -F dir=/var/cache/yum -k exclude
-a exclude,always -F msgtype=PATH

# Ignore all the anonymous events. Often tagged on every rule, but ignoring 
# up front should improve processing time
-a exit,never -F auid=4294967295
# Ignore system services
-a exit,never -F auid<1000

## Ignore SELinux AVC records
-a always,exclude -F msgtype=AVC

## Ignore current working directory records
-a always,exclude -F msgtype=CWD

## Ignore EOE records (End Of Event, not needed)
-a always,exclude -F msgtype=EOE

## Cron jobs fill the logs with stuff we normally don't want (works with SELinux)
-a never,user -F subj_type=crond_t
-a exit,never -F subj_type=crond_t

## This is not very interesting and wastes a lot of space if the server is public facing
-a always,exclude -F msgtype=CRYPTO_KEY_USER

## VMWare tools
-a exit,never -F arch=b64 -S fork -F success=0 -F path=/usr/lib64/open-vm-tools -F subj_type=initrc_t -F exit=-2

### High Volume Event Filter (especially on Linux Workstations)
-a exit,never -F arch=b64 -F dir=/dev/shm -k sharedmemaccess
-a exit,never -F arch=b64 -F dir=/var/lock/lvm -k locklvm

###########################
## DISA STIG Audit Rules ##
###########################
# Watch syslog configuration
-w /etc/rsyslog.conf
-w /etc/rsyslog.d/
# Watch PAM and authentication configuration
-w /etc/pam.d/
-w /etc/nsswitch.conf
# Watch system log files
-w /var/log/messages
-w /var/log/audit/audit.log
-w /var/log/audit/audit[1-9].log
# Watch audit configuration files
-w /etc/audit/auditd.conf -p wa
-w /etc/audit/audit.rules -p wa
# Watch login configuration
-w /etc/login.defs
-w /etc/securetty
-w /etc/resolv.conf
# Watch cron and at
-w /etc/at.allow
-w /etc/at.deny
-w /var/spool/at/
-w /etc/crontab
-w /etc/anacrontab
-w /etc/cron.allow
-w /etc/cron.deny
-w /etc/cron.d/
-w /etc/cron.hourly/
-w /etc/cron.weekly/
-w /etc/cron.monthly/
# Watch shell configuration
-w /etc/profile.d/
-w /etc/profile
-w /etc/shells
-w /etc/bashrc
-w /etc/csh.cshrc
-w /etc/csh.login
# Watch kernel configuration
-w /etc/sysctl.conf
-w /etc/modprobe.conf
# Watch linked libraries
-w /etc/ld.so.conf -p wa
-w /etc/ld.so.conf.d/ -p wa
# Watch init configuration
-w /etc/rc.d/init.d/
-w /etc/sysconfig/
-w /etc/inittab -p wa
-w /etc/rc.local
-w /usr/lib/systemd/
-w /etc/systemd/
# Watch filesystem and NFS exports
-w /etc/fstab
-w /etc/exports
# Watch xinetd configuration
-w /etc/xinetd.conf
-w /etc/xinetd.d/
# Watch Grub2 configuration
-w /etc/grub2.cfg
-w /etc/grub.d/
# Watch TCP_WRAPPERS configuration
-w /etc/hosts.allow
-w /etc/hosts.deny
# Watch sshd configuration
-w /etc/ssh/sshd_config
# Audit system events
-a always,exit -F arch=b32 -S acct -S reboot -S sched_setparam -S sched_setscheduler -S setrlimit -S swapon 
-a always,exit -F arch=b64 -S acct -S reboot -S sched_setparam -S sched_setscheduler -S setrlimit -S swapon 
# Audit any link creation
-a always,exit -F arch=b32 -S link -S symlink
-a always,exit -F arch=b64 -S link -S symlink
##############################
## NIST 800-53 Requirements ##
##############################
#2.6.2.4.1 Records Events that Modify Date and Time Information
-a always,exit -F arch=b32 -S adjtimex -S stime -S settimeofday -S clock_settime -k time-change
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -S clock_settime -k time-change
-w /etc/localtime -p wa -k time-change
#2.6.2.4.2 Record Events that Modify User/Group Information
-w /etc/group -p wa -k identity
-w /etc/passwd -p wa -k identity
-w /etc/gshadow -p wa -k identity
-w /etc/shadow -p wa -k identity
-w /etc/security/opasswd -p wa -k identity
-w /etc/group -p wa -k audit_rules_usergroup_modification
-w /etc/gshadow -p wa -k audit_rules_usergroup_modification
#2.6.2.4.3 Record Events that Modify the Systems Network Environment
-a always,exit -F arch=b32 -S sethostname -S setdomainname -k audit_network_modifications
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k audit_network_modifications
-w /etc/issue -p wa -k audit_network_modifications
-w /etc/issue.net -p wa -k audit_network_modifications
-w /etc/hosts -p wa -k audit_network_modifications
-w /etc/sysconfig/network -p wa -k audit_network_modifications
#2.6.2.4.4 Record Events that Modify the System Mandatory Access Controls
-w /etc/selinux/ -p wa -k MAC-policy
#2.6.2.4.5 Ensure auditd Collects Logon and Logout Events
-w /var/log/faillog -p wa -k logins
-w /var/log/lastlog -p wa -k logins
-w /var/run/faillock -p wa -k logins
#2.6.2.4.6 Ensure auditd Collects Process and Session Initiation Information
-w /var/run/utmp -p wa -k session
-w /var/log/btmp -p wa -k session
-w /var/log/wtmp -p wa -k session
#2.6.2.4.7 Ensure auditd Collects Discretionary Access Control Permission Modification Events
-a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -k perm_mod
-a always,exit -F arch=b32 -S chown -S fchown -S fchownat -S lchown -k perm_mod
-a always,exit -F arch=b32 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -k perm_mod
-a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -k perm_mod
-a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -k perm_mod
-a always,exit -F arch=b64 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -k perm_mod

#2.6.2.4.8 Ensure auditd Collects Unauthorized Access Attempts to Files (unsuccessful)
-a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -k access
-a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -k access
-a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -k access
-a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -k access

#2.6.2.4.9 Ensure auditd Collects Information on the Use of Privileged Commands
-a always,exit -F path=/sbin/semanage -F perm=x -F key=privileged-priv_change
-a always,exit -F path=/sbin/setsebool -F perm=x -F key=privileged-priv_change
-a always,exit -F path=/bin/chcon -F perm=x -F key=privileged-priv_change
-a always,exit -F path=/sbin/restorecon -F perm=x -F key=privileged-priv_change
-a always,exit -F path=/bin/userhelper -F perm=x -F key=privileged
-a always,exit -F path=/bin/sudoedit -F perm=x -F auid>=1000 -F auid!=unset -F key=privileged
-a always,exit -F path=/bin/sudo -F perm=x -F auid>=1000 -F auid!=unset -F key=privileged
EOF

# Find All privileged commands and monitor them
for PROG in `find / -type f -perm -4000 -o -type f -perm -2000 2>/dev/null`; do echo "-a always,exit -F path=$PROG -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged"  >> /etc/audit/rules.d/audit.rules; done

cat <<EOF >> /etc/audit/rules.d/audit.rules
#2.6.2.4.10 Ensure auditd Collects Information on Exporting to Media (successful)
-a always,exit -F arch=b32 -S mount -F auid>=1000 -F auid!=unset -F key=export
-a always,exit -F arch=b64 -S mount -F auid>=1000 -F auid!=unset -F key=export

#2.6.2.4.11 Ensure auditd Collects Files Deletion Events by User (successful and unsuccessful)
-a always,exit -F arch=b32 -S unlink -S rmdir -S unlinkat -S rename -S renameat -k delete
-a always,exit -F arch=b64 -S unlink -S rmdir -S unlinkat -S rename -S renameat -k delete

#2.6.2.4.12 Ensure auditd Collects System Administrator Actions
-w /etc/sudoers -p wa -k actions
-w /etc/sudoers.d/ -p wa -k actions
###Ensure auditd Collects account access alerts
-w /var/log/tallylog -p wa -k logins 
-w /var/run/faillock/ -p wa -k logins
#2.6.2.4.13 Monitor Kernel Modules
-w /sbin/insmod -p x -k modules
-w /sbin/rmmod -p x -k modules
-w /sbin/modprobe -p x -k modules
-a always,exit -F arch=b32 -S init_module -S delete_module -k modules
-a always,exit -F arch=b64 -S init_module -S delete_module -k modules
-a always,exit -F arch=b32 -S create_module -k module-change
-a always,exit -F arch=b64 -S create_module -k module-change
-a always,exit -F arch=b32 -S finit_module -k module-change
-a always,exit -F arch=b64 -S finit_module -k module-change
###monitor use of the open_by_handle_at command in /etc/audit/rules.d/audit.rules
-a always,exit -F arch=b64 -S open_by_handle_at -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F arch=b64 -S open_by_handle_at -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
-a always,exit -F path=/usr/sbin/setfiles -F perm=x -F auid>=1000 -F auid!=4294967295 -k privileged-priv_change
-w /usr/bin/kmod -p x -F auid!=4294967295 -k module-change
-a always,exit -F arch=b64 -S execve -C uid!=euid -F euid=0 -k setuid
-a always,exit -F arch=b64 -S execve -C gid!=egid -F egid=0 -k setgid
#2.6.2.4.14 Make the auditd Configuration Immutable
-e 2
EOF

####
#Compress rotated audit log files
####
cat << EOF |tee -a /etc/cron.daily/compaudit.sh
#!/bin/bash
##renames and compresses rotated audit.log files for posterity sake
##toss in a /etc/cron.weekly or /etc/cron.daily on the central audit log server.
export PATH=/sbin:/bin:/usr/sbin:/usr/bin

FORMAT="%F_%T"  # Customize timestamp format as desired, per `man date`
                # %F_%T will lead to files like: audit.log.2015-02-26_15:43:46
COMPRESS=gzip   # Change to bzip2 or xz as desired

rename_and_compress_old_logs() {
    for file in $(find /var/log/audit/ -name 'audit.log.[0-9]'); do
        timestamp=$(ls -l --time-style="+${FORMAT}" ${file} | awk '{print $6}')
        newfile=${file%.[0-9]}.${timestamp}
        # Optional: remove "-v" verbose flag from next 2 lines to hide output
        mv -v ${file} ${newfile}
        ${COMPRESS} -v ${newfile}
    done
}

rename_and_compress_old_logs
service auditd rotate
rename_and_compress_old_logs
EOF

###
#use ocsp
###
sed -i 's/ca, signature/ca, ocsp_on, signature/g' /etc/pam_pkcs11/pam_pkcs11.conf

###
#lockdown yum
###
echo -e "localpkg_gpgcheck=1\nrepo_gpgcheck=1\nclean_requirements_on_remove=1" |sudo tee -a >>/etc/yum.conf

####
#Firm up SSHD
####
ssh-keygen -b 4096 -t rsa -N "" -f /etc/ssh/ssh_host_rsa_key
ssh-keygen -b 1024 -t dsa -N "" -f /etc/ssh/ssh_host_dsa_key
ssh-keygen -b 521 -t ecdsa -N "" -f /etc/ssh/ssh_host_ecdsa_key
chmod 0600 /etc/ssh/*key
chmod 0640 /etc/ssh/*pub
sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
sed -i 's/#StrictModes yes/StrictModes yes/' /etc/ssh/sshd_config
sed -i 's/MaxAuthTries 6/MaxAuthTries 3/' /etc/ssh/sshd_config
sed -i 's/#PrintLastLog yes/PrintLastLog yes/' /etc/ssh/sshd_config
sed -i 's/#ClientAliveInterval 0/ClientAliveInterval 300/' /etc/ssh/sshd_config
sed -i 's/#ClientAliveCountMax 3/ClientAliveCountMax 0/' /etc/ssh/sshd_config
sed -i 's/Banner none/Banner \/etc\/issue/' /etc/ssh/sshd_config
sed -i 's/^Ciphers .*/Ciphers aes128-ctr,aes192-ctr,aes256-ctr/' /etc/ssh/sshd_config
sed -i 's/^MACs .*/MACs hmac-sha2-512,hmac-sha2-256' /etc/ssh/sshd_config

systemctl reload sshd

####
#use ntpd instead of chrony per DISA
#set for your time server source
####
timedatectl set-ntp false
systemctl stop chronyd
systemctl disable chronyd
systemctl mask chronyd
systemctl enable ntpd
echo "maxpoll 10" >>/etc/ntp.conf
systemctl start ntpd

####
#tweaks to sysctl.conf and limits.conf
####
echo -e "*  hard maxlogins 10\nroot soft nofile 10240\nroot hard nofile 68480" >>/etc/security/limits.conf
echo "net.ipv6.conf.all.disable_ipv6 = 1" |sudo tee -a /etc/sysctl.d/10-stig.conf
echo "net.ipv6.conf.default.disable_ipv6 = 1" |sudo tee -a /etc/ssysctl.d/10-stig.conf
echo "net.ipv6.conf.default.accept_redirects = 0" |sudo tee -a /etc/sysctl.d/10-stig.conf
echo "net.ipv6.conf.all.accept_redirects = 0" |sudo tee -a /etc/sysctl.d/10-stig.conf
echo "net.ipv6.conf.all.accept_source_route = 0" |sudo tee -a /etc/sysctl.d/10-stig.conf
echo "net.ipv6.conf.all.accept_ra = 0" >> /etc/sysctl.d/10-stig.conf
echo "net.ipv6.conf.default.accept_ra = 0" >> /etc/sysctl.d/10-stig.conf
echo "net.ipv4.ip_forward = 0" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.conf.all.send_redirects = 0" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.conf.default.send_redirects = 0" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.icmp_ignore_bogus_error_responses = 1" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.conf.all.accept_source_route = 0" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.conf.all.accept_redirects = 0" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.conf.all.log_martians = 1" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.conf.default.log_martians = 1" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.conf.default.accept_source_route = 0" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.conf.default.accept_redirects = 0" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.icmp_echo_ignore_broadcasts = 1" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.conf.all.rp_filter = 1" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.conf.default.rp_filter = 1" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.tcp_max_syn_backlog = 1280" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.conf.all.rp_filter = 1" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.conf.default.rp_filter = 1" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.tcp_timestamps = 0" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.tcp_sack = 0" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.tcp_syncookies = 1" >>/etc/sysctl.d/10-stig.conf
echo "net.core.rmem_max = 8388608" >>/etc/sysctl.d/10-stig.conf
echo "net.core.wmem_max = 8388608" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.tcp_rmem = 4096 87380 8388608" >>/etc/sysctl.d/10-stig.conf
echo "net.ipv4.tcp_wmem = 4096 87380 8388608" >>/etc/sysctl.d/10-stig.conf
echo "fs.file-max = 6815744" >>/etc/sysctl.d/10-stig.conf
echo "kernel.dmesg_restrict = 1" >>/etc/sysctl.d/10-stig.conf
sudo /sbin/sysctl -p /etc/sysctl.d/10-stig.conf

####
#Disable postfix smtp relaying per STIG RHEL-07-040680
####
postconf -e 'smtpd_client_restrictions = permit_mynetworks,reject'
systemctl reload postfix

######
# Make SELinux Configuration Immutable
######
chattr +i /etc/selinux/config

#######
# DISA BANNER CONFIGURATION for stig
#######
BANNER_MESSAGE_TEXT='You are accessing a U.S. Government (USG) Information System (IS) that is \nprovided for USG-authorized use only. By using this IS (which includes any \ndevice attached to this IS), you consent to the following conditions:\n\n-The USG routinely intercepts and monitors communications on this IS for \npurposes including, but not limited to, penetration testing, COMSEC monitoring, \nnetwork operations and defense, personnel misconduct (PM), law enforcement \n(LE), and counterintelligence (CI) investigations.\n\n-At any time, the USG may inspect and seize data stored on this IS.\n\n-Communications using, or data stored on, this IS are not private, are subject \nto routine monitoring, interception, and search, and may be disclosed or used \nfor any USG-authorized purpose.\n\n-This IS includes security measures (e.g., authentication and access controls) \nto protect USG interests -- not for your personal benefit or privacy.\n\n-Notwithstanding the above, using this IS does not constitute consent to PM, LE \nor CI investigative searching or monitoring of the content of privileged \ncommunications, or work product, related to personal representation or services \nby attorneys, psychotherapists, or clergy, and their assistants. Such \ncommunications and work product are private and confidential. See User \nAgreement for details.\n\n'
echo -e "${BANNER_MESSAGE_TEXT}" > /etc/issue
echo -e "${BANNER_MESSAGE_TEXT}" > /etc/issue.net

####
# Firewall rule to impose rate limiting to mitigate DoS per STIG RHEL-07-040510.
####
firewall-cmd --set-default-zone=drop
firewall-cmd --permanent --direct --add-rule ipv4 filter IN_public_allow 0 -p tcp -m limit --limit 25/minute --limit-burst 100 -j ACCEPT
systemctl reload firewalld

########################################
# GNOME 3 Lockdowns
########################################
if [ -x /bin/gsettings ]; then
	cat << EOF > /etc/dconf/db/gdm.d/99-gnome-hardening
[org/gnome/login-screen]
banner-message-enable=true
banner-message-text="${BANNER_MESSAGE_TEXT}"
disable-user-list=true
disable-restart-buttons=true

[org/gnome/desktop/lockdown]
user-administration-disabled=true
disable-user-switching=true

[org/gnome/desktop/media-handling]
automount=false
automount-open=false
autorun-never=true

[org/gnome/desktop/notifications] 
show-in-lock-screen=false

[org/gnome/desktop/privacy]
remove-old-temp-files=true
remove-old-trash-files=true
old-files-age=7

[org/gnome/desktop/interface]
clock-format="12h"

[org/gnome/desktop/screensaver]
user-switch-enabled=false
lock-enabled=true

[org/gnome/desktop/session]
idle-delay=900

[org/gnome/desktop/thumbnailers]
disable-all=true

[org/gnome/nm-applet]
disable-wifi-create=true

EOF
	cat << EOF > /etc/dconf/db/gdm.d/locks/99-gnome-hardening
/org/gnome/login-screen/banner-message-enable
/org/gnome/login-screen/banner-message-text
/org/gnome/login-screen/disable-user-list
/org/gnome/login-screen/disable-restart-buttons
/org/gnome/desktop/lockdown/user-administration-disabled
/org/gnome/desktop/lockdown/disable-user-switching
/org/gnome/desktop/media-handling/automount
/org/gnome/desktop/media-handling/automount-open
/org/gnome/desktop/media-handling/autorun-never
/org/gnome/desktop/notifications/show-in-lock-screen
/org/gnome/desktop/privacy/remove-old-temp-files
/org/gnome/desktop/privacy/remove-old-trash-files
/org/gnome/desktop/privacy/old-files-age
/org/gnome/desktop/screensaver/user-switch-enabled
/org/gnome/desktop/screensaver/lock-enabled
/org/gnome/desktop/session/idle-delay
/org/gnome/desktop/thumbnailers/disable-all
/org/gnome/nm-applet/disable-wifi-create
EOF
	cat << EOF > /usr/share/glib-2.0/schemas/99-custom-settings.gschema.override
[org.gnome.login-screen]
banner-message-enable=true
banner-message-text="${BANNER_MESSAGE_TEXT}"
disable-user-list=true
disable-restart-buttons=true

[org.gnome.desktop.lockdown]
user-administration-disabled=true
disable-user-switching=true

[org.gnome.desktop.media-handling]
automount=false
automount-open=false
autorun-never=true

[org.gnome.desktop.notifications] 
show-in-lock-screen=false

[org.gnome.desktop.privacy]
remove-old-temp-files=true
remove-old-trash-files=true
old-files-age=7

[org.gnome.desktop.interface]
clock-format="12h"

[org.gnome.desktop.screensaver]
user-switch-enabled=false
lock-enabled=true

[org.gnome.desktop.session]
idle-delay=900

[org.gnome.desktop.thumbnailers]
disable-all=true

[org.gnome.nm-applet]
disable-wifi-create=true

EOF

	cat << EOF > /etc/gdm/custom.conf
# GDM configuration storage
[daemon]
AutomaticLoginEnable=false
TimedLoginEnable=false

[security]

[xdmcp]

[greeter]

[chooser]

[debug]

EOF
	cp /etc/dconf/db/gdm.d/locks/99-gnome-hardening /etc/dconf/db/local.d/locks/99-gnome-hardening
 	/bin/glib-compile-schemas /usr/share/glib-2.0/schemas/
	/bin/dconf update
fi


####
#Set to graphical boot
####
systemctl set-default graphical.target

####
#Firefox hardening
####
cat <<EOF |sudo tee -a /usr/lib64/firefox/defaults/preferences/autoconfig.js
pref("general.config.obscure_value", 0);
pref("general.config.filename", "mozilla.cfg");
EOF
cat <<EOF |sudo tee -a /usr/lib64/firefox/mozilla.cfg
//
lockPref("security.default_personal_cert", "Ask Every Time");
EOF
echo "lockPref(\"network.protocol-handler.external.shell\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"plugin.disable_full_page_plugin_for_types\", \"application/pdf,application/fdf,application/xfdf,application/lsl,application/lso,application/lss,application/iqy,application/rqy,application/xlk,application/xls,application/xlt,appliation/pot,application/pps,application/dos,application/dot,application/wks,application/bat,application/ps,application/eps,application/wch,application/wcm,application/wb1,application/wb3,application/rtf,application/doc,application/mdb,application/mde,application/wbk,application/wb1,application/wch,application/wcm,application/ad,application/adp\");" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"browser.formfill.enable\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"signon.prefillForms\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"signon.rememberSignons\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"privacy.sanitize.timeSpan\", 40);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"privacy.sanitize.promptOnSanitize\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"dom.disable_window_open_feature.status\", true);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"dom.disable_window_move_resize\", true);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"security.enable_tls\", true);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"security.enable_ssl2\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"security.enable_ssl3\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"security.tls.version.min\", 1);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"security.tls.version.max\", 3);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"dom.disable_window_flip\", true);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"dom.event.contextmenu.enabled\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"dom.disable_window_move_resize\", true);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"dom.disable_window_flip\", true);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"dom.disable_window_status_change\", true);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"dom.disable_window_open_feature.status\", true);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"security.warn_leaving_secure\", true);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"app.update.enabled\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"extensions.update.enabled\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"browser.search.update\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"browser.urlbar.autocomplete.enabled\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg
echo "lockPref(\"xpinstall.enabled\", false);" |sudo tee -a /usr/lib64/firefox/mozilla.cfg

########################################
# AIDE Initialization
########################################
#FIPS MODE AIDE CONFIGURATION
/usr/bin/sed -i -e 's/^FIPSR.*/FIPSR = p+i+n+u+g+s+m+c+acl+selinux+xattrs+sha256/' -e 's/^NORMAL.*/NORMAL = FIPSR+sha512/' /etc/aide.conf
# AIDE Initialization
echo "Initializing AIDE database, this step may take quite a while!"
/usr/sbin/aide --init &> /dev/null
echo "AIDE database initialization complete."
cp /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
# Weekly Reports
cat <<EOF > /etc/cron.weekly/aide-report
#!/bin/sh
# Generate Weekly AIDE Report
\`/usr/sbin/aide --check | tee -a /var/log/aide/reports/\$(hostname)-aide-report-\$(date +%Y%m%d).txt | /bin/mail -s "\$(hostname) - AIDE Integrity Check" root@localhost\`
EOF
chown root:root /etc/cron.weekly/aide-report
chmod 555 /etc/cron.weekly/aide-report
mkdir -p /var/log/aide/reports
chmod 700 /var/log/aide/reports

####
#enable kernel fips mode
####
echo "PRELINKING=no" > /etc/sysconfig/prelink
prelink -u -a
dracut -f
BOOT=UUID=$(findmnt -no uuid LABEL=BOOTFS)
sed -i 's/nousb/boot='"${BOOT}"' fips=1 ipv6.disable=1/' /etc/default/grub
if [ -e /sys/firmware/efi ]; then
 grub2-mkconfig -o /boot/efi/EFI/redhat/grub.cfg
 chmod 600 /boot/efi/EFI/redhat/grub.cfg
else
  grub2-mkconfig -o /boot/grub2/grub.cfg
  chmod 600 /boot/grub2/grub.cfg
fi

#####
# Set Removeable Media and tmp filesystems to noexec
#####
for DEVICE in $(/bin/lsblk | grep ^sr | awk '{ print $1 }'); do
	mkdir -p /mnt/$DEVICE
	echo -e "/dev/$DEVICE\t\t/mnt/$DEVICE\t\tiso9660\tdefaults,ro,noexec,nosuid,noauto\t0 0" >> /etc/fstab
done
for DEVICE in $(cd /dev;ls *cd* *dvd*); do
	mkdir -p /mnt/$DEVICE
	echo -e "/dev/$DEVICE\t\t/mnt/$DEVICE\t\tiso9660\tdefaults,ro,noexec,nosuid,noauto\t0 0" >> /etc/fstab
done
echo -e "tmpfs\t\t\t/dev/shm\t\ttmpfs\tnoexec,nosuid,nodev\t\t0 0" >> /etc/fstab
systemctl enable tmp.mount

# Remove TMOUT variable (set in /etc/profile.d/stig-timeout.{sh,csh})
/usr/bin/sed -i '/TMOUT/d' /etc/profile

###
# SCAP Complience Report
###
cat << EOF >> /root/scap_generate_report.sh
#!/bin/bash
######
# Create SSG Complience Report
oscap xccdf eval --profile stig --results \$(hostname)-scap-report-\$(date +%F).xml --report \$(hostname)-scap-report-\$(date +%Y%m%d).html --cpe /usr/share/xml/scap/ssg/content/ssg-rhel7-cpe-dictionary.xml /usr/share/xml/scap/ssg/content/ssg-rhel7-xccdf.xml
exit 0
EOF
chmod 500 /root/scap_generate_report.sh

%end
